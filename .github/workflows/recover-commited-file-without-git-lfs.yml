on:
  push:
    branches-ignore:
      - main
      - develop

jobs:
  recover_commited_file_without_git_lfs:
    name: recover_commited_file_without_git_lfs
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
          lfs: true
    - name: recover
      run: |
        midified_file_num=`git diff --name-only --diff-filter=M |wc -l`
        echo midified_file_num=${midified_file_num}
        if [ $midified_file_num -ne 0 ]; then
          branch_name=`echo "${GITHUB_REF}" | sed s@refs/heads/@@g`
          git config remote.origin.fetch '+refs/heads/*:refs/remotes/origin/*'
          git fetch origin
          git fetch --unshallow
          git checkout origin/${branch_name} -b ${branch_name}_work
          git config --global user.name "$GITHUB_ACTOR"
          git config --global user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git log --pretty=format:"%s %n%n%b" -1 > log.txt
          git reset --mixed HEAD^
          git add *
          git restore --staged log.txt
          git commit --file=log.txt
          git push -f origin ${branch_name}_work:${branch_name}
          rm log.txt
        fi